@model FYP.Models.Customer
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<FYP.Localization.SharedResource> L
@{
    ViewData["Title"] = L["Make a Reservation"];
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="center-container">
    <div class="register-form" style="max-width: 700px;">
        <partial name="~/Views/Shared/_BackButton.cshtml" model="@Url.Action("Index","Customer")" />

        @if (TempData["Success"] != null)
        {
            { ViewData["Type"] = "success"; ViewData["Message"] = TempData["Success"]; }
            <partial name="~/Views/Shared/_AlertMessage.cshtml" />
        }
        @if (TempData["Error"] != null)
        {
            { ViewData["Type"] = "error"; ViewData["Message"] = TempData["Error"]; }
            <partial name="~/Views/Shared/_AlertMessage.cshtml" />
        }
        @if (TempData["Message"] != null)
        {
            { ViewData["Type"] = "success"; ViewData["Message"] = TempData["Message"]; }
            <partial name="~/Views/Shared/_AlertMessage.cshtml" />
        }

        <!-- Header -->
        <div style="margin-bottom: var(--spacing-xl); text-align: center;">
            <h1 class="gold-heading" style="font-size: 2rem; margin-bottom: var(--spacing-xs);">
                @L["Make a Reservation"]
            </h1>
            <p style="color: var(--text-secondary);">
                @L["Reserve your table for an exceptional dining experience"]
            </p>
        </div>

        <hr class="gold-hr" />

        <!-- Reservation Form -->
        <form asp-controller="Customer" asp-action="Reserve" method="post">
            @Html.AntiForgeryToken()
            
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">
                        <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.125rem; margin-right: 0.25rem;">calendar_today</span>
                        @L["Date"] <span style="color: var(--color-primary-red);">*</span>
                    </label>
                    <div style="position: relative;">
                        <input type="text" class="form-control" required 
                               placeholder="DD/MM/YYYY"
                               id="reservationDateInput" 
                               value="@(ViewBag.ReservationDate != null && ViewBag.ReservationDate != default(DateTime) ? ((DateTime)ViewBag.ReservationDate).ToString("dd/MM/yyyy") : "")"
                               style="padding-right: 45px;" />
                        <input type="date" 
                               id="reservationDatePicker" 
                               style="position: absolute; opacity: 0; pointer-events: none;"
                               min="@DateTime.Now.ToString("yyyy-MM-dd")"
                               value="@(ViewBag.ReservationDate != null && ViewBag.ReservationDate != default(DateTime) ? ((DateTime)ViewBag.ReservationDate).ToString("yyyy-MM-dd") : "")" />
                        <input type="hidden" id="reservationDateHidden" name="ReservationDate" 
                               value="@(ViewBag.ReservationDate != null && ViewBag.ReservationDate != default(DateTime) ? ((DateTime)ViewBag.ReservationDate).ToString("yyyy-MM-dd") : "")" />
                        <button type="button" 
                                class="btn btn-link" 
                                id="calendarIconBtn"
                                style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); padding: 5px; color: var(--text-secondary); border: none; background: none; cursor: pointer;">
                            <span class="material-symbols-outlined" style="font-size: 1.25rem;">calendar_today</span>
                        </button>
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">
                        <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.125rem; margin-right: 0.25rem;">schedule</span>
                        @L["Time"] <span style="color: var(--color-primary-red);">*</span>
                    </label>
                    <input id="customerTimePicker" type="text" class="form-control" placeholder="HH:mm" required />
                    <input type="hidden" id="customerTimeHidden" name="ReservationTime" value="@ViewBag.ReservationTime" />
                    @* Validation handled by browser tooltip *@
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label fw-semibold">
                    <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.125rem; margin-right: 0.25rem;">groups</span>
                    @L["Party Size"] <span style="color: var(--color-primary-red);">*</span>
                </label>
                <input name="PartySize" type="number" min="1" class="form-control" 
                       placeholder="Number of guests" value="@(ViewBag.PartySize ?? 2)" required />
                <small class="form-text" style="color: var(--color-primary-gold);">@L["Large parties are allowed if capacity is available. Limits are enforced automatically."]</small>
            </div>

            <div class="form-group mb-4">
                <label class="form-label fw-semibold">
                    <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.125rem; margin-right: 0.25rem;">notes</span>
                    @L["Notes"] <small style="color: var(--text-muted);">(@L["Optional"])</small>
                </label>
                <textarea name="Notes" class="form-control" rows="4" 
                          placeholder="@L["Any dietary restrictions or special occasions?"]">@ViewBag.Notes</textarea>
            </div>

            <!-- More Options (Collapsible) -->
            <div class="mb-4">
                <button class="btn btn-link p-0 text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#moreOptions" aria-expanded="false" aria-controls="moreOptions" style="color: var(--color-primary-gold); font-weight: 600;">
                    <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.125rem; margin-right: 0.25rem;">expand_more</span>
                    @L["More"]
                </button>
                <div class="collapse mt-3" id="moreOptions">
                    <div class="card card-body" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">
                                    <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.125rem; margin-right: 0.25rem;">timer</span>
                                    @L["Duration"] (@L["minutes"])
                                </label>
                                <select name="Duration" class="form-control">
                                    <option value="90">90 @L["minutes"] (@L["Standard"])</option>
                                    <option value="120">120 @L["minutes"]</option>
                                    <option value="150">150 @L["minutes"]</option>
                                    <option value="180">180 @L["minutes"]</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex gap-3 mt-4">
                <a asp-action="Index" asp-controller="Customer" class="btn btn-secondary flex-fill">
                    <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 0.5rem;">cancel</span>
                    @L["Cancel"]
                </a>
                <button type="submit" class="btn btn-confirm flex-fill">
                    <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 0.5rem;">restaurant</span>
                    @L["Reserve Table"]
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('reservationDateInput');
    const datePicker = document.getElementById('reservationDatePicker');
    const dateHidden = document.getElementById('reservationDateHidden');
    
    if (dateInput && datePicker) {
        // Function to convert yyyy-MM-dd to DD/MM/YYYY
        function formatToDDMMYYYY(isoDate) {
            if (!isoDate) return '';
            const date = new Date(isoDate + 'T00:00:00');
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        // Function to convert DD/MM/YYYY to yyyy-MM-dd
        function formatToISO(ddmmYYYY) {
            if (!ddmmYYYY || ddmmYYYY.length !== 10) return '';
            const parts = ddmmYYYY.split('/');
            if (parts.length !== 3) return '';
            const day = parts[0].padStart(2, '0');
            const month = parts[1].padStart(2, '0');
            const year = parts[2];
            return `${year}-${month}-${day}`;
        }
        
        // When date picker changes, update the visible input and hidden field
        datePicker.addEventListener('change', function() {
            if (this.value) {
                const formatted = formatToDDMMYYYY(this.value);
                dateInput.value = formatted;
                if (dateHidden) {
                    dateHidden.value = this.value;
                }
            }
        });
        
        // Calendar icon button opens the date picker
        const calendarBtn = document.getElementById('calendarIconBtn');
        if (calendarBtn) {
            calendarBtn.addEventListener('click', function(e) {
                e.preventDefault();
                datePicker.showPicker ? datePicker.showPicker() : datePicker.click();
            });
        }
        
        // Allow manual typing in DD/MM/YYYY format
        dateInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2);
            }
            if (value.length >= 5) {
                value = value.substring(0, 5) + '/' + value.substring(5, 9);
            }
            
            e.target.value = value;
            
            // Convert DD/MM/YYYY to yyyy-MM-dd for form submission
            if (value.length === 10) {
                const isoDate = formatToISO(value);
                if (isoDate) {
                    datePicker.value = isoDate;
                    if (dateHidden) {
                        dateHidden.value = isoDate;
                    }
                }
            }
        });
        
        // Also allow clicking the input to open picker
        dateInput.addEventListener('focus', function() {
            datePicker.showPicker ? datePicker.showPicker() : datePicker.click();
        });
        
        // Handle form submission - ensure date is converted
        const form = document.querySelector('form[asp-controller="Customer"]') || document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                const value = dateInput.value;
                if (value.length === 10) {
                    const isoDate = formatToISO(value);
                    if (isoDate && dateHidden) {
                        dateHidden.value = isoDate;
                    }
                } else if (datePicker.value && dateHidden) {
                    dateHidden.value = datePicker.value;
                }
            });
        }
    }
    
    // Handle More Options collapse icon rotation
    const moreOptionsCollapse = document.getElementById('moreOptions');
    const moreButton = document.querySelector('[data-bs-target="#moreOptions"]');
    
    if (moreOptionsCollapse && moreButton) {
        const icon = moreButton.querySelector('.material-symbols-outlined');
        
        moreOptionsCollapse.addEventListener('show.bs.collapse', function () {
            if (icon) {
                icon.style.transform = 'rotate(180deg)';
                icon.textContent = 'expand_less';
            }
        });
        
        moreOptionsCollapse.addEventListener('hide.bs.collapse', function () {
            if (icon) {
                icon.style.transform = 'rotate(0deg)';
                icon.textContent = 'expand_more';
            }
        });
    }

    // Time Validation Logic
    const timeInput = document.getElementById('customerTimePicker');
    const timeHidden = document.getElementById('customerTimeHidden');
    
    function validateTime() {
        if (!timeInput || !timeInput.value) {
             if (timeInput) timeInput.setCustomValidity(""); // Reset
             return; 
        }

        // 1. Business Hours Check (10:00 - 22:00)
        const [hours, minutes] = timeInput.value.split(':').map(Number);
        const totalMinutes = hours * 60 + minutes;
        const open = 10 * 60; // 10:00
        const close = 22 * 60; // 22:00

        if (totalMinutes < open || totalMinutes > close) {
            timeInput.setCustomValidity("Selected time is outside business hours (10:00 AM - 10:00 PM).");
        } 
        else {
             // 2. Past Time Check
             let isPast = false;
             
             if (dateHidden && dateHidden.value) {
                const dateParts = dateHidden.value.split('-'); // yyyy-MM-dd
                if (dateParts.length === 3) {
                    const year = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]) - 1; 
                    const day = parseInt(dateParts[2]);
                    
                    const selectedDateTime = new Date(year, month, day, hours, minutes);
                    const now = new Date();

                    if (selectedDateTime < now) {
                        isPast = true;
                    }
                }
             }
             
             if (isPast) {
                 timeInput.setCustomValidity("Date and time cannot be in the past.");
             } else {
                 timeInput.setCustomValidity(""); // Valid
             }
        }
    }

    if (timeInput) {
        flatpickr(timeInput, {
            enableTime: true,
            noCalendar: true,
            // Hidden field keeps 24-hour HH:mm, visible shows 12-hour AM/PM
            dateFormat: 'H:i',
            altInput: true,
            altFormat: 'h:i K',
            time_24hr: false,
            defaultDate: timeHidden?.value || null,
            onChange: function(selectedDates, dateStr) {
                if (timeHidden) timeHidden.value = dateStr;
                validateTime();
            },
            onClose: function(selectedDates, dateStr) {
                if (timeHidden) timeHidden.value = dateStr;
                validateTime();
            }
        });
        timeInput.addEventListener('input', function(e){ e.preventDefault(); return false; });
        timeInput.addEventListener('change', validateTime);
        
        // Trigger on load
        validateTime();
        
        // Also trigger when date changes
        if (datePicker) {
            datePicker.addEventListener('change', validateTime);
        }
        
        // Trigger when manual date input changes
        if (dateInput) {
            dateInput.addEventListener('input', validateTime);
            dateInput.addEventListener('blur', validateTime);
        }
    }
});
</script>

<style>
/* Force better date input styling */
input[type="date"] {
    position: relative;
}

input[type="date"]::-webkit-calendar-picker-indicator {
    cursor: pointer;
    filter: invert(0.5);
    padding: 5px;
    position: absolute;
    right: 10px;
}

[data-theme="dark"] input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(0.8);
}

input[type="date"]::-webkit-datetime-edit-fields-wrapper {
    padding: 0;
}

input[type="date"]::-webkit-datetime-edit-text {
    color: var(--text-secondary);
    padding: 0 0.2em;
}

input[type="date"]::-webkit-datetime-edit-month-field,
input[type="date"]::-webkit-datetime-edit-day-field,
input[type="date"]::-webkit-datetime-edit-year-field {
    color: var(--text-primary);
    padding: 2px;
}

input[type="date"]::-webkit-datetime-edit-day-field:focus,
input[type="date"]::-webkit-datetime-edit-month-field:focus,
input[type="date"]::-webkit-datetime-edit-year-field:focus {
    background-color: var(--color-primary-gold);
    color: white;
    outline: none;
    border-radius: 3px;
}

/* Ensure proper spacing */
input[type="date"] {
    font-family: inherit;
}

/* More Options collapse styling */
#moreOptions .material-symbols-outlined {
    transition: transform 0.3s ease;
}

[data-bs-target="#moreOptions"] .material-symbols-outlined {
    transition: transform 0.3s ease;
    display: inline-block;
}

[data-bs-target="#moreOptions"]:hover {
    color: var(--color-primary-gold) !important;
    opacity: 0.8;
}
</style>
