@model IEnumerable<FYP.Models.Reservation>
@{
    ViewData["Title"] = "Manage Reservations";
    var filterDate = ViewBag.FilterDate as DateTime? ?? DateTime.UtcNow.Date;
}

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="gold-heading">Reservations - @filterDate.ToString("MMMM dd, yyyy")</h2>
        <a asp-action="CreateWalkIn" class="btn btn-primary">
            <i class="bi bi-person-plus"></i> New Walk-In
        </a>
    </div>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }
    @if (TempData["Message"] != null)
    {
        <div class="alert alert-success">@TempData["Message"]</div>
    }

    <!-- Date Filter -->
    <div class="card mb-4">
        <div class="card-body">
            <form asp-action="Reservations" method="get" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="filterDate" class="form-label">Select Date</label>
                    <input type="date" name="filterDate" id="filterDate" class="form-control" 
                           value="@filterDate.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-secondary w-100">Filter</button>
                </div>
                <div class="col-md-2">
                    <a asp-action="Reservations" class="btn btn-outline-secondary w-100">Today</a>
                </div>
            </form>
        </div>
    </div>

    @if (Model == null || !Model.Any())
    {
        <div class="alert alert-info">
            <p>No reservations for this date.</p>
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>Time</th>
                        <th>Type</th>
                        <th>Customer/Guest</th>
                        <th>Party</th>
                        <th>Table</th>
                        <th>Status</th>
                        <th>Duration</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var reservation in Model)
                    {
                        var statusBadge = reservation.ReservationStatus.StatusName switch
                        {
                            "Pending" => "badge bg-warning text-dark",
                            "Confirmed" => "badge bg-success",
                            "Seated" => "badge bg-info",
                            "Completed" => "badge bg-secondary",
                            "Cancelled" => "badge bg-danger",
                            _ => "badge bg-light text-dark"
                        };

                        var typeBadge = reservation.ReservationType ? "badge bg-primary" : "badge bg-secondary";
                        var typeText = reservation.ReservationType ? "Pre-booked" : "Walk-in";

                        var customerName = reservation.IsGuest && reservation.Guest != null
                            ? $"{reservation.Guest.FirstName} {reservation.Guest.LastName}"
                            : reservation.Customer != null 
                                ? $"{reservation.Customer.FirstName} {reservation.Customer.LastName}"
                                : "Unknown";

                        <tr>
                            <td><strong>@reservation.ReservationTime.ToString(@"hh\:mm")</strong></td>
                            <td><span class="@typeBadge">@typeText</span></td>
                            <td>@customerName</td>
                            <td>@reservation.PartySize</td>
                            <td>
                                @if (reservation.ReservationTables != null && reservation.ReservationTables.Any())
                                {
                                    var tableNumbers = string.Join(", ", reservation.ReservationTables.Select(rt => rt.Table.TableNumber));
                                    <span>Table @tableNumbers</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td><span class="@statusBadge">@reservation.ReservationStatus.StatusName</span></td>
                            <td>@reservation.Duration min</td>
                            <td>@(reservation.Notes ?? "-")</td>
                            <td>
                                <!-- Status Update Dropdown -->
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" 
                                            data-bs-toggle="dropdown">
                                        Change Status
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <form asp-action="UpdateStatus" method="post" style="display:inline;">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="reservationId" value="@reservation.ReservationID" />
                                                <input type="hidden" name="statusId" value="2" />
                                                <button type="submit" class="dropdown-item">Confirmed</button>
                                            </form>
                                        </li>
                                        <li>
                                            <form asp-action="UpdateStatus" method="post" style="display:inline;">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="reservationId" value="@reservation.ReservationID" />
                                                <input type="hidden" name="statusId" value="3" />
                                                <button type="submit" class="dropdown-item">Seated</button>
                                            </form>
                                        </li>
                                        <li>
                                            <form asp-action="UpdateStatus" method="post" style="display:inline;">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="reservationId" value="@reservation.ReservationID" />
                                                <input type="hidden" name="statusId" value="4" />
                                                <button type="submit" class="dropdown-item">Completed</button>
                                            </form>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <form asp-action="UpdateStatus" method="post" style="display:inline;">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="reservationId" value="@reservation.ReservationID" />
                                                <input type="hidden" name="statusId" value="5" />
                                                <button type="submit" class="dropdown-item text-danger">Cancelled</button>
                                            </form>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>
